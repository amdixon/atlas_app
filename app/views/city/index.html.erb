
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsHokK7K5SsgGteZDd8gl2G0OfC9a8eQg&sensor=false"></script>
<link href='http://fonts.googleapis.com/css?family=Lato:300,700|Prata' rel='stylesheet' type='text/css'>


<!-- PROFILE SLIDE IN LEFT -->

<div id="profile" style="display: none">
  <div id='profile-content'>
	<%= render 'profiles/profile' %>
  </div>
</div>



<!-- MASONRY INFINITE SCROLL CONTENT -->
<div id="content-super">

  <div id="content">
  
    <div id="tumblelog" style="opacity: 0">
      
  
      <% @city.each do |city| %>
      <div class="story col2">
        <h1 id="city_name"><%= city.name %></h1>
        <h4 id="city_country"><%= city.country %></h4>
        <p id="city_id" style="display: none"><%= city.id %></p>
      </div>
      <% end %>
      
      
      <div class="story col2" id="flickr_0">
      </div>
    
      
      <div class="story col2">
        <h2 style="font-size: 12px">VITALS</h2>
        <p id="wiki_0"></p>
      </div>
    
      
      <div class="story col1">
        <blockquote id="twitter_0">
        </blockquote>
      </div>
    
      
      <div class="story col1" id="twitter_1">
      </div>
    
      
      <div class="story col2" id="flickr_1">
      </div>
    
      
      <div class="story col1">
        <div style="display: block; height: 110px">
          THE CURRENT TEMP<br>
          <span style="float:left"><h2 id="weather_0" style="font-size: 60px; margin: 8px 0 -4px 0">  </h2></span>
          <span style="float:right"><p  id="weather_1" style="margin: 12px  0 0"> </p></span>
          <br>
        </div>
        
        <div style="display: block">
          CONDITIONS
          <blockquote id="weather_2"></blockquote>
        </div>
      </div>
      
      
      <div class="story col1" id="flickr_2">
      </div>
    
      
      <div class="story col1">
        <blockquote id="twitter_3">
        </blockquote>
      </div>
    
    
      
      <div class="story col1">
        <h2>TWEET</h2>
           <p id="twitter_4"></p>
        </ul>
      </div>
    
      
      <div class="story col2">
        <h3 id="twitter_5"></h3>
        <h3 id="twitter_6"></h3>
      </div>
    
      
      
      <div class="story col3" id="flickr_3">
      </div>
    
      
      
      <div class="story col2">
        <h3 id="twitter_7"></h3>
      </div>
    
    
      <div class="story col2">
        <h2>WHATS GOING ON</h2>    
           <p id="twitter_8"></p><br>
           <p id="twitter_9"></p><br>
           <p id="twitter_10"></p><br>
      </div>
    
      
      <div class="story col1">
        <blockquote> 
          <p id="twitter_11"></p>
        </blockquote>
      </div>
    
      
      <div class="story col2" id="flickr_4">
      </div>
    
      
      <div class="story col1">
        <p id="twitter_12"> </p>
      </div>
    
    
      <div class="story col1" id="flickr_5">
      </div>
    
    
      
      <div class="story col1">
        <blockquote>
          <p id="twitter_13"></p>
        </blockquote>
      </div>
    
      
      <div class="story col1">
        <h2>MORE NEWS</h2>
          <p id="twitter_14">
        </p>
      </div>
    
    
      <div class="story col3" id="flickr_6">
      </div>
  
  
    </div> <!-- /#tumblelog -->
  
  </div><!-- /#content -->

</div><!-- /#content-super -->


<!-- GOOGLE MAPS -->
<div id="map_container">
  <div id="map_wrap">
    <div id="map_canvas">
      
    </div>
  </div>
</div>


<!-- FOOTER -->
<div id="footer-main">
  
  <span class='btn-wrap' id='profile-click'>
    <div class='footer-btn' id='profile-btn'></div>
  </span>
	
	<% @city.each do |city| %>
  	<% if signed_in? %>
	<%= form_for @newfav, remote: true do |f| %>
		<%= f.hidden_field :profile_id, :value => current_user.id %>
		<%= f.hidden_field :city_id, :value => city.id %>
		<%= f.hidden_field :name, :value => city.name %>
		<%= f.hidden_field :country, :value => city.country %>
		<span class='btn-wrap'>
		  <%= f.submit '', id: "save-btn" %>
		</span>
	<% end %>
	<% else %>
		<span class='btn-wrap'>
		  <a id="fake-save-btn" href="#" alt="Login to save places."></a>
		</span>
	<% end %>
	<% end %>

  <div id="search-wrap">
    
    <%= form_tag city_index_path, :method => 'get', :class => 'footer-search' do %>
      <%= text_field_tag :search, params[:search], :id => 'again', :title => "Enter City or Spin", :class => 'jq_watermark'  %>
      <%= submit_tag "SPIN", :name => nil  %>
    <% end %>
    
    
  </div>
  
  <div id="logo">
	<%= link_to :root do %>
    <%= image_tag 'logo.png' %>
	<% end %>
  </div>
  
</div>






<script>
  var height = $(window).height()
  var width = $(window).width()
  $.watermarker.setDefaults({left: -3});
  
  //erase footer search bar autofill
  $('#again').val('')
  
  //masonry loader
  var masonryContent = $('#tumblelog')
  
  
  $(masonryContent).imagesLoaded( function(){
      $(masonryContent).masonry({
          columnWidth: 240,
          isAnimated: true,
      })
  })
  
  /////// LOAD WHEN DOCUMENT READY /////////////
  $(document).ready( function(){
  
    $('#again').autocomplete({
      source: "/search_suggestions",
      delay: 100,
      minLength: 2,
      position: { my: "left bottom", at: "left top"}
    })
    
    
    $('#again').focus( function(){
      $(this).animate({
          'border-top': '2px solid #aaa',
          'width': '320px',
      }, 10)
    })
    
      
  })//// document ready ////
  
  
  
  
  
  
  //set viewport height for scrolling
  $('#content-super').height( height - 60 )
  //set map height and width
  $('#map_canvas').height(height).width( width )
  
  
  
  /////// RE-SORTING PAGE AFTER AJAX API REQUESTS ///////
  setTimeout( function(){
    $(masonryContent).animate({'opacity': 1.0}, 1000);
    $('#content-super').jScrollPane();
  }, 2500)
  setTimeout( function(){
      $(masonryContent).masonry();
      codeAddress();
      
  }, 2000)
  


  //////// AJAX CALL SETTINGS ////////
  $.ajaxSetup({ cache:true });

  var city_name = $('#city_name').text();
  var city_country = $('#city_country').text();
  var lattitude;
  var longitude;
  
  
  
  //////// FLICKR API /////////////
  var flickrURL = "http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=6cd67f99c979719b322e087ba4030fe8&safe_search=1&per_page=20&license=1";
  var flickrQuery = flickrURL + "&tags=" + city_name
  
  $.getJSON(flickrQuery + "&format=json&jsoncallback=?", function(data){
      $.each(data.photos.photo, function(i,item){
          var src = "http://farm"+ item.farm +".static.flickr.com/"+ item.server +"/"+ item.id +"_"+ item.secret +"_z.jpg";
          var flickr_location  = '#flickr_' + ( parseInt(i)/3 -1 );
          
          if (parseInt(i) % 3 == 0){
            $(flickr_location).append( $("<img/>").attr("src", src) )
          }
          if ( i == 19 ) return false;
      });
  });

  
  
  //////// TWITTER API /////////////
  var twitterURL = "http://search.twitter.com/search.json?callback=?&q=%23"
  var twitterQuery = twitterURL + city_name 
  var twitterCheck = $('#city_id').text()
  
  //add #travel to search if popular city
  if ( twitterCheck < 100 ){
    twitterQuery += "%23travel"
  }
  
  $.getJSON(twitterQuery, function(data){
      $.each(data.results, function(i,tweet){
            
        // Build the html string for the current tweet
        var tweet_html = '<div class="tweet_text">' + tweet.text + '<br>';
        tweet_html += '<span class="attweet">@' + tweet.from_user + '</span></div>';
  
        // Append html string to tweet_container div
        var tweet_location = '#twitter_' + parseInt(i);
        $(tweet_location).append(tweet_html);
          
        if ( i == 14 ) return false;
      });
    
  });
  
  
  
  //////// WIKIPEDIA API /////////////
  var freeURL = "https://www.googleapis.com/freebase/v1/text/en/";
  var freeQuery = freeURL + city_name.split(' ').join('_').toLowerCase();
  
  $.getJSON(freeQuery, function(data){
        var free_html = data.result;
        var free_split = free_html.split('.');
        
        // Append html string to container
        $('#wiki_0').append( free_split[0] + '.' + free_split[1] );
  });
    
  
  
  ////////$$$$ WEATHERUNDERGROUD API $$$$/////////////
  var weatherURL = "http://api.wunderground.com/api/4474a3b5db4c2d7e/conditions/q/"
  
  //Check if its a US city then do a geolookup
  if (city_country == "UNITED STATES"){
    $.ajax({
      url : weatherURL + city_name + '.json',
      dataType : "jsonp",
      success : function(data) {
        var weatherGeo = data.response.results[0].zmw;
        console.log( weatherGeo );
        var weatherQuery = weatherURL + weatherGeo + ".json"
        
        weatherSearch( weatherQuery )
      }
    })
  } else {
    var weatherQuery = weatherURL + city_country + "/" + city_name + ".json"
    
    weatherSearch( weatherQuery )
  }
  
  
  function weatherSearch( weatherQuery ) {
    $.ajax({
    url : weatherQuery,
    dataType : "jsonp",
    success : function(data) {
      var temp_f = data['current_observation']['temp_f'];
      var temp_c = data['current_observation']['temp_c'];
      var weatherString = data['current_observation']['weather']
      
      var latitude = data['current_observation']['display_location']['latitude']
      var longitude = data['current_observation']['display_location']['longitude']
      
      
      var weather_F = temp_f + '&#176;F'
      var weather_C = temp_c + '&#176; C'
      
      $('#weather_0').append( weather_F )
      $('#weather_1').append( weather_C )
      $('#weather_2').append( weatherString )
      
      }
    });
  };
  
  //////// MAPS API /////////////
  var geocoder;
      var map;
      
  var styles = [
      {
        "featureType": "water",
        "stylers": [
          { "color": "#d2d2d2" }
        ]
      },{
        "featureType": "road",
        "stylers": [
          { "weight": 0.5 },
          { "color": "#ffffff" }
        ]
      },{
        "featureType": "poi",
        "stylers": [
          { "color": "#e3e4d5" }
        ]
      },{
      },{
        "featureType": "administrative",
        "elementType": "labels",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "transit",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
      },{
      },{
        "featureType": "administrative",
        "stylers": [
          { "color": "#f3f3f1" }
        ]
      },{
        "featureType": "landscape",
        "stylers": [
          { "color": "#f3f3f3" }
        ]
      },{
        "featureType": "poi",
        "stylers": [
          { "color": "#f3f3f3" }
        ]
      },{
        "featureType": "water",
        "stylers": [
          { "color": "#f3f3f3" }
        ]
      },{
      }
    ]
  
      function initialize() {
        geocoder = new google.maps.Geocoder();
        var latlng = new google.maps.LatLng(-34.397, 150.644);
        var mapOptions = {
          zoom: 13,
          disableDefaultUI: true,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          styles: styles,
          
        }
        map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
      }

      function codeAddress() {
        initialize();
        var city = city_name;
        
        var address = city;
        geocoder.geocode( { 'address': address}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);

          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }
  
  
  
</script>





